<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header> 
        <nav class="nav_menu">
            <h3>GESTOR DE TAREAS</h3>
            <img id="logoImage" src="https://res.cloudinary.com/dvikvg6ml/image/upload/v1693860781/Benergy_logo_bueno_t2wwiw.png" width="150px" alt="">
        </nav>
    </header>
    <main>
        <section>
            <nav class="nav_menu2">
                <!-- lista de los campos -->
                <div class="form-control-sm">
                    <select class="" name="filterFieldName" id="filterFieldName">
                        <option value="" disabled selected>Nombre del campo</option>
                        
                    </select>
    
                    <select name="filterType" id="filterType">
                        <option value="" disabled selected>Operador</option>
                        <option value="Contains">Contiene</option>
                        <option value="Equals">Es igual a</option>
                        <option value="Greater">Mayor que</option>
                        <option value="Less">Menor que</option>
                        <option value="NotContains">No contiene</option>
                        <option value="NotEquals">No es igual a</option>
                        <option value="GreaterOrEqual">Mayor o igual que</option>
                        <option value="LessOrEqual">Menor o igual que</option>
    
                    </select>
                    <input type="text" id="filterValue" placeholder="Valor de filtro">
                    <div id="filtroContainer">

                    </div>

                    
                </div>
                <div class="botones" >
                    <button type="button" onclick="agregarFiltro()">Agregar filtro</button>
                    <button type="button" onclick="aplicarFiltros()">Aplicar filtro</button>
                    <button type="button"onclick="recargarIframe()">Actualizar</button>
                    <button type="button" onclick="limpiarFiltros()">Limpiar filtros</button>
                </div>
            </nav>
            <!-- Aqui se define URL base -->
            <iframe id="myIframe" class="airtable-embed" src="" frameborder="0" onmousewheel="" width="100%" height="720" style= "background: transparent; border: 1px solid #ccc;"></iframe>
        </section>
    </main>
    <script src="apiLogo.js"></script>

</body>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const select = document.getElementById('filterFieldName');
    const newBaseUrl = urlParams.get('baseUrl');
 
    // Verificar si newBaseUrl tiene un valor y asignar la URL del iframe
    if (newBaseUrl) {
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;
    }

    // Obtener los valores de los par치metros c1, c2, c3, c4, c5
    const c1 = urlParams.get('c1');
    const c2 = urlParams.get('c2');
    const c3 = urlParams.get('c3');
    const c4 = urlParams.get('c4');
    const c5 = urlParams.get('c5');

    // Funcion para agregar una opcion al select
    function agregarOpcion(valor) {
        const option = document.createElement('option');
        option.value = valor;
        option.textContent = valor;
        select.appendChild(option);
    }

    // Verificar si cada variable tiene valor y agregar opciones
    if (c1) {
        agregarOpcion(c1);
    }
    if (c2) {
        agregarOpcion(c2);
    }
    if (c3) {
        agregarOpcion(c3);
    }
    if (c4) {
        agregarOpcion(c4);
    }
    if (c5) {
        agregarOpcion(c5);
    }

    // Variable global para almacenar las condiciones
    const condiciones = [];

    // Funcion para agregar un filtro a la lista de filtros
    function agregarFiltro() {
        const campo = document.getElementById("filterFieldName").value;
        const valor = document.getElementById("filterValue").value;
        const tipoDeFiltro = document.getElementById("filterType").value;

        // Verifica si se han seleccionado valores v치lidos
        if (campo && tipoDeFiltro && valor) {
            // Agrega la condicion actual al array de condiciones
            condiciones.push({ campo, tipoDeFiltro, valor });

            // Crea los elemtentos para mostrar el filtro agregado
            const filtroContainer = document.getElementById("filtroContainer");
            const filtroElement = document.createElement("div");
            filtroElement.innerHTML = `
                <select>
                    <option value="${campo}" selected>${campo}</option>
                </select>
                <select>
                    <option value="${tipoDeFiltro}" selected>${tipoDeFiltro}</option>
                </select>
                <input type="text" value="${valor}">
            `;
            filtroContainer.appendChild(filtroElement);

            // Limpia los campos de entrada
            document.getElementById("filterFieldName").value = "";
            document.getElementById("filterValue").value = "";
            document.getElementById("filterType").value = "";
            
        } else {
            alert("Por favor, complete todos los campos para agregar un filtro.");
        }
    }

    // Funci칩n para aplicar los filtros
    function aplicarFiltros() {
        // Verifica si hay al menos una condici칩n para aplicar filtros
        if (condiciones.length > 0 && newBaseUrl) {
            // Construir la URL del iframe con todas las condiciones
            let iframeUrl = newBaseUrl;
            condiciones.forEach((condicion, index) => {
                const { campo, tipoDeFiltro, valor } = condicion;
                const valorCodificado = encodeURIComponent(valor);
                iframeUrl += `&filter${tipoDeFiltro}_${campo}=${valorCodificado}`;
            });

            // Establecer la URL construida como fuente del iframe
            const iframe = document.getElementById("myIframe");
            iframe.src = iframeUrl;
        } else {
            alert("Agregue al menos un filtro y una URL base antes de aplicar filtros.");
        }
    }



    // Funcion para limpiar los filtros
    function limpiarFiltros() {
        // Limpia la lista de filtros y el array de condiciones
        const filtroContainer = document.getElementById("filtroContainer");
        filtroContainer.innerHTML = "";
        condiciones.length = 0;

        // Restablecer la URL del iframe a la URL original sin filtros
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;


        // Limpia los campos de entrada y los radio buttons
        document.getElementById("filterFieldName").value = "";
        document.getElementById("filterValue").value = "";
        document.getElementById("filterType").value = "";
    }

    function recargarIframe(){
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl; 
    }



    
</script>
</html>
