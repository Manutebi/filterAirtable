<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header> 
        <nav class="nav_menu">
            <div id="title" class="title">
                <p></p>
            </div>
            <div class="logo">
                <img id="logoImage" src="https://res.cloudinary.com/dvikvg6ml/image/upload/v1693860781/Benergy_logo_bueno_t2wwiw.png" width="80px" alt="">
            </div>
        </nav>
    </header>
    <main>
        <section>
            <nav class="nav_menu2">
                <!-- lista de los campos -->
                <div class="form-control-sm">
                    <select class="" name="filterFieldName" id="filterFieldName">
                        <option value="" disabled selected>Nombre del campo</option>                        
                    </select>
    
                    <select name="filterType" id="filterType">
                        <option value="" disabled selected>Operador</option>
                        <option value="Contains">Contiene</option>
                        <option value="Equals">Es igual a</option>
                        <option value="Greater">Mayor que</option>
                        <option value="Less">Menor que</option>
                        <option value="NotContains">No contiene</option>
                        <option value="NotEquals">No es igual a</option>
                        <option value="GreaterOrEqual">Mayor o igual que</option>
                        <option value="LessOrEqual">Menor o igual que</option>
    
                    </select>
                    <input type="text" id="filterValue" placeholder="Valor de filtro">
                    <div id="filtroContainer">

                    </div>
                </div>
                <div class="botones" >
                    <button type="button" onclick="agregarFiltro()">Agregar filtro</button>
                    <button type="button" onclick="aplicarFiltros()">Aplicar filtro</button>
                    <button type="button"onclick="recargarIframe()">Actualizar</button>
                    <button type="button" onclick="limpiarFiltros()">Limpiar filtros</button>
                    <button type="button" onclick="mostrarFiltros()">Mostrar filtros</button>
                </div>
            </nav>
            <!-- Aqui se define URL base -->
            <iframe id="myIframe" class="airtable-embed" src="" frameborder="0" onmousewheel="" width="100%" height="90%" style= "background: transparent; border: 1px solid #ccc;"></iframe>
        </section>
    </main>

</body>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const select = document.getElementById('filterFieldName');
    const newBaseUrl = urlParams.get('baseUrl');

    if (newBaseUrl) {
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;
    }

    // Definir una función para agregar una opción al select
    function agregarOpcion(valor) {
        const option = document.createElement('option');
        option.value = valor;
        option.textContent = valor;
        select.appendChild(option);
    }

    // Obtener y agregar opciones para los 30 parámetros (c1, c2, ..., c30)
    for (let i = 1; i <= 30; i++) {
        const paramName = 'c' + i;
        const paramValue = urlParams.get(paramName);
        if (paramValue) {
            agregarOpcion(paramValue);
        }
    }


    //Obtener los parametros por URL Logo y titulo
    const logo = urlParams.get('logo');
    const logoImage = document.getElementById('logoImage');
    logoImage.src = logo;

    if (logo){
        logoImage.src = logo;
    }else{
        logoImage.src = 'https://res.cloudinary.com/dvikvg6ml/image/upload/v1693860781/Benergy_logo_bueno_t2wwiw.png'
    }



    
    const paragraph = urlParams.get('parrafo');
    const title = document.getElementById('title');
    title.innerHTML = paragraph;

    //////////////////////////////////////////////

    // Variable global para almacenar las condiciones
    const condiciones = [];

    // Funcion para agregar un filtro a la lista de filtros
    function agregarFiltro() {
    const campo = document.getElementById("filterFieldName").value;
    const valor = document.getElementById("filterValue").value;
    const tipoDeFiltro = document.getElementById("filterType").value;

        // Verifica si se han seleccionado valores válidos
        if (campo && tipoDeFiltro && valor) {
            // Agrega la condicion actual al array de condiciones
            condiciones.push({ campo, tipoDeFiltro, valor });

            // Limpia los campos de entrada
            document.getElementById("filterFieldName").value = "";
            document.getElementById("filterValue").value = "";
            document.getElementById("filterType").value = "";
            
        } else {
            alert("Por favor, complete todos los campos para agregar un filtro.");
        }
    }

    function mostrarFiltros() {
    // Crea la ventana emergente
    const ventanaEmergente = window.open("", "Filtros Agregados", "width=400,height=400");

    // Agrega los filtros a la ventana emergente
    let contenido = "<h2>Filtros Agregados:</h2>";
    for (let i = 0; i < condiciones.length; i++) {
        const condicion = condiciones[i];
        contenido += `<p>${condicion.campo} ${condicion.tipoDeFiltro} ${condicion.valor} <button onclick="eliminarFiltro(${i})">Eliminar</button></p>`;
    }

        // Define la funcion eliminarFiltro en la ventana emergente
        ventanaEmergente.document.body.innerHTML = contenido;
        ventanaEmergente.eliminarFiltro = function(index) {
            // Elimina el filtro seleccionado del array de condiciones
            condiciones.splice(index, 1);

            // Actualiza la vista de la página para reflejar los cambios
            const filtroContainer = document.getElementById("filtroContainer");
            filtroContainer.innerHTML = "";

            // Aplica los filtros restantes
            aplicarFiltros();

            // Actualiza la ventana emergente para reflejar los cambios
            mostrarFiltros();
        };
    } 



    // function mostrarFiltros() {
    //     // Crea la ventana emergente
    //     const ventanaEmergente = window.open("", "Filtros Agregados", "width=400,height=400");

    //     // Agrega los filtros a la ventana emergente
    //     let contenido = "<h2>Filtros Agregados:</h2>";
    //     for (let i = 0; i < condiciones.length; i++) {
    //         const condicion = condiciones[i];
    //         contenido += `<p>${condicion.campo} ${condicion.tipoDeFiltro} ${condicion.valor}</p>`;
    //     }
    //     ventanaEmergente.document.body.innerHTML = contenido;
    // }



    // Función para aplicar los filtros
    function aplicarFiltros() {
        // Verifica si hay al menos una condición para aplicar filtros
        if (condiciones.length > 0 && newBaseUrl) {
            // Construir la URL del iframe con todas las condiciones
            let iframeUrl = newBaseUrl;
            condiciones.forEach((condicion, index) => {
                const { campo, tipoDeFiltro, valor } = condicion;
                const valorCodificado = encodeURIComponent(valor);
                iframeUrl += `&filter${tipoDeFiltro}_${campo}=${valorCodificado}`;
            });

            // Establecer la URL construida como fuente del iframe
            const iframe = document.getElementById("myIframe");
            iframe.src = iframeUrl;
        } else {
            alert("Agregue al menos un filtro y una URL base antes de aplicar filtros.");
        }
    }



    // Funcion para limpiar los filtros
    function limpiarFiltros() {
        // Limpia la lista de filtros y el array de condiciones
        const filtroContainer = document.getElementById("filtroContainer");
        filtroContainer.innerHTML = "";
        condiciones.length = 0;

        // Restablecer la URL del iframe a la URL original sin filtros
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;


        // Limpia los campos de entrada y los radio buttons
        document.getElementById("filterFieldName").value = "";
        document.getElementById("filterValue").value = "";
        document.getElementById("filterType").value = "";
    }

    //Recarga el Iframe po locoo

    function recargarIframe(){
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl; 
    }


</script>
</html>
