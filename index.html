<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header> 
        <nav class="nav_menu">
            <div class="title">
                <p id="title" ></p>
            </div>
            <div class="logo">
                <img id="logoImage" src="https://res.cloudinary.com/dvikvg6ml/image/upload/v1693860781/Benergy_logo_bueno_t2wwiw.png" width="80px" alt="">
            </div>
        </nav>
    </header>
    <main>
        <section>
            <nav class="nav_menu2">
                <!-- lista de los campos -->
                <div class="form-control-sm">
                    <select class="" name="filterFieldName" id="filterFieldName">
                        <option value="" disabled selected>Nombre del campo</option>                        
                    </select>
    
                    <select name="filterType" id="filterType">
                        <option value="" disabled selected>Operador</option>
                        <option value="Contains">Contiene</option>
                        <option value="Equals">Es igual a</option>
                        <option value="Greater">Mayor que</option>
                        <option value="Less">Menor que</option>
                        <option value="NotContains">No contiene</option>
                        <option value="NotEquals">No es igual a</option>
                        <option value="GreaterOrEqual">Mayor o igual que</option>
                        <option value="LessOrEqual">Menor o igual que</option>
    
                    </select>
                    <input type="text" id="filterValue" placeholder="Valor de filtro">
                    <div id="filtroContainer">

                    </div>
                </div>
                <div class="botones" >
                    <button type="button" onclick="agregarFiltro()">Agregar filtro</button>
                    <button type="button" id="botonAplicar" onclick="aplicarFiltros()" disabled>Aplicar filtro</button>
                    <button type="button"onclick="recargarIframe()">Actualizar</button>
                    <button type="button" onclick="limpiarFiltros()">Limpiar filtros</button>
                    <button id="botonMostrarFiltros" type="button" onclick="mostrarFiltros()">Filtros</button>

                    <!-- <button class="filter-button" id="filterButton">
                        <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800">
                            <path d="m509.796 326.874c-44.857-87.465-142.483-166.874-253.796-166.874-112.094 0-209.436 80.377-253.796 166.874-2.938 5.729-2.938 12.523 0 18.253 44.857 87.464 142.483 166.873 253.796 166.873 126.04 0 218.947-98.922 253.796-166.874 2.938-5.729 2.938-12.523 0-18.252zm-253.796 145.126c-90.776 0-166.974-60.307-212.956-136 45.473-74.855 121.428-136 212.956-136 91.137 0 167.232 60.735 212.956 136-46.194 76.038-122.697 136-212.956 136zm-249.697-360.828c7.39-8.209 20.037-8.871 28.246-1.48l44.544 40.107c8.208 7.392 8.871 20.037 1.48 28.246-7.391 8.21-20.038 8.87-28.246 1.48l-44.544-40.108c-8.208-7.39-8.871-20.036-1.48-28.245zm229.697-11.172v-80c0-11.045 8.954-20 20-20s20 8.955 20 20v80c0 11.045-8.954 20-20 20s-20-8.955-20-20zm-126.8-44.545c-4.493-10.091.045-21.913 10.136-26.406 10.092-4.493 21.913.045 26.406 10.136l30.587 68.7c4.493 10.09-.045 21.913-10.136 26.406-10.062 4.479-21.898-.014-26.406-10.136zm322.227 122.59c-7.391-8.208-6.729-20.854 1.48-28.246l44.544-40.107c8.208-7.391 20.855-6.729 28.246 1.48 7.391 8.208 6.729 20.854-1.48 28.245l-44.544 40.108c-8.211 7.392-20.856 6.727-28.246-1.48zm-95.757-70.16 30.587-68.7c4.493-10.091 16.315-14.629 26.406-10.136s14.629 16.315 10.136 26.406l-30.587 68.699c-4.513 10.137-16.36 14.609-26.406 10.137-10.09-4.493-14.628-16.315-10.136-26.406zm-79.67 129.865c-54.175 0-98.25 44.075-98.25 98.25s44.075 98.25 98.25 98.25 98.25-44.075 98.25-98.25-44.075-98.25-98.25-98.25zm0 156.5c-32.119 0-58.25-26.131-58.25-58.25s26.131-58.25 58.25-58.25 58.25 26.131 58.25 58.25-26.131 58.25-58.25 58.25z"/>
                        </svg>
                    </button> -->
                </div>

                <!-- Pop-up -->
                <div class="popup" id="popup">
                    
                </div>
            </nav>
            <!-- Aqui se define URL base -->
            <iframe id="myIframe" class="airtable-embed" src="" frameborder="0" onmousewheel="" width="100%" height="88%" style= "background: transparent; border: 1px solid #ccc;"></iframe>
        </section>
    </main>

</body>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const select = document.getElementById('filterFieldName');
    const newBaseUrl = urlParams.get('baseUrl');

    if (newBaseUrl) {
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;
    }

    // Definir una función para agregar una opción al select
    function agregarOpcion(valor) {
        const option = document.createElement('option');
        option.value = valor;
        option.textContent = valor;
        select.appendChild(option);
    }

    // Obtener y agregar opciones para los 30 parámetros (c1, c2, ..., c30)
    for (let i = 1; i <= 30; i++) {
        const paramName = 'c' + i;
        const paramValue = urlParams.get(paramName);
        if (paramValue) {
            agregarOpcion(paramValue);
        }
    }


    //Obtener los parametros por URL Logo y titulo
    const logo = urlParams.get('logo');
    const logoImage = document.getElementById('logoImage');
    logoImage.src = logo;

    if (logo){
        logoImage.src = logo;
    }else{
        logoImage.src = 'https://res.cloudinary.com/dvikvg6ml/image/upload/v1693860781/Benergy_logo_bueno_t2wwiw.png'
    }



    
    const paragraph = urlParams.get('parrafo');
    const title = document.getElementById('title');
    title.innerHTML = paragraph;

    //////////////////////////////////////////////

    const condiciones = [];

    function agregarFiltro() {
    const campo = document.getElementById("filterFieldName").value;
    const valor = document.getElementById("filterValue").value;
    const tipoDeFiltro = document.getElementById("filterType").value;

    if (campo && tipoDeFiltro && valor) {
        condiciones.push({ campo, tipoDeFiltro, valor });
        document.getElementById("filterFieldName").value = "";
        document.getElementById("filterValue").value = "";
        document.getElementById("filterType").value = "";

        // Habilita el botón "Aplicar filtro"
        document.getElementById("botonAplicar").disabled = false;
    } else {
        alert("Por favor, complete todos los campos para agregar un filtro.");
    }

    aplicarFiltros();

    // Actualiza el contador de filtros
    actualizarContadorFiltros();
}


    function eliminarFiltro(index) {
        condiciones.splice(index, 1);
        const filtroContainer = document.getElementById("filtroContainer");
        filtroContainer.innerHTML = "";
        aplicarFiltros();

        // Deshabilita el botón "Aplicar filtro" si no hay más filtros
        if (condiciones.length === 0) {
            document.getElementById("botonAplicar").disabled = true;
            cerrarPopup();
        }
            


        // Actualiza el contador de filtros
        actualizarContadorFiltros();
        //Mostrar los filtros restantes
        mostrarFiltros();

    }

    function mostrarFiltros() {
    // Crea un objeto que mapee los valores de las opciones a sus textos
    const opciones = {
        "Contains": "Contiene",
        "Equals": "Es igual a",
        "Greater": "Mayor que",
        "Less": "Menor que",
        "NotContains": "No contiene",
        "NotEquals": "No es igual a",
        "GreaterOrEqual": "Mayor o igual que",
        "LessOrEqual": "Menor o igual que"
    };

    const popup = document.getElementById("popup");
    let contenido = "<h4>Filtros Agregados:</h4>";
    for (let i = 0; i < condiciones.length; i++) {
        const condicion = condiciones[i];
        // Obtiene el texto de la opción correspondiente al valor del filtro
        const textoOpcion = opciones[condicion.tipoDeFiltro];
        contenido += `<p>${condicion.campo} ${textoOpcion} ${condicion.valor} <button onclick="eliminarFiltro(${i})">X</button></p>`;
    }
    popup.innerHTML = contenido;
}


    




    // function mostrarFiltros() {
    //     const popup = document.getElementById("popup");
    //     let contenido = "<h4>Filtros Agregados:</h4>" ;
    //     for (let i = 0; i < condiciones.length; i++) {
    //         const condicion = condiciones[i];
    //         contenido += `<p>${condicion.campo} ${condicion.tipoDeFiltro} ${condicion.valor} <button onclick="eliminarFiltro(${i})">X</button></p>`;
    //     }
    //     popup.innerHTML = contenido;
    // }

    function aplicarFiltros() {
        if (newBaseUrl) {
            let iframeUrl = newBaseUrl;
            condiciones.forEach((condicion, index) => {
                const { campo, tipoDeFiltro, valor } = condicion;
                const valorCodificado = encodeURIComponent(valor);
                iframeUrl += `&filter${tipoDeFiltro}_${campo}=${valorCodificado}`;
            });
            const iframe = document.getElementById("myIframe");
            iframe.src = iframeUrl;
        } else {
            alert("Agregue una URL base antes de aplicar filtros.");
        }
    }

    function actualizarContadorFiltros() {
        const botonMostrarFiltros = document.getElementById("botonMostrarFiltros");
        botonMostrarFiltros.textContent = `Filtros (${condiciones.length})`;
    }

    function limpiarFiltros() {
        const filtroContainer = document.getElementById("filtroContainer");
        filtroContainer.innerHTML = "";
        condiciones.length = 0;
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;
        document.getElementById("filterFieldName").value = "";
        document.getElementById("filterValue").value = "";
        document.getElementById("filterType").value = "";

        actualizarContadorFiltros();

    }

    function recargarIframe() {
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;



    }

    const filterButton = document.getElementById('botonMostrarFiltros');
    const popup = document.getElementById('popup');


    function togglePopup() {
        popup.classList.toggle('show-popup');
    }

    filterButton.addEventListener('click', () => {
        togglePopup();
    });

    function cerrarPopup() {
    togglePopup();
}






</script>
</html>
