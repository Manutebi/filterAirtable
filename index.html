<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="titleDocument" >Filtros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link id="favIcon" rel="shortcut icon" href="" type="image/x-icon">
</head>
<body>
    <header> 
        <nav class="nav_menu">
            <div class="title">
                <p id="title" ></p>
            </div>
            <div class="logo">
                <a href="#contenidoDuplicado">
                    <button id="mostrar" class="mostrar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                            <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                            <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                        </svg>
                    </button>
                </a>
                <button id="ocultar" class="ocultarContenido">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16">
                    <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/>
                    <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/>
                </svg>
                </button>
                <img id="logoFilter" src="img/filtrar (3).png" alt="">
                <img id="logoImage" src=""  alt="">
            </div>
        </nav>
    </header>
    <main>
        <section id="miSeccion">
            <nav class="nav_menu2">
                <!-- lista de los campos -->
                <div class="form-control-sm">
                    <select class="" name="filterFieldName" id="filterFieldName">
                        <option value="" disabled selected>Nombre del campo</option>                        
                    </select>

                    <select name="filterType" id="filterType">
                        <option value="" disabled selected>Seleccione filtro</option>
                        <option value="Contains">Contiene</option> 
                        <option value="Equals">Es igual a</option> 
                        <option value="Greater">Mayor que</option> 
                        <option value="Less">Menor que</option> 
                        <option value="NotContains">No contiene</option>
                        <option value="NotEquals">No es igual a</option> 
                        <option value="GreaterOrEqual">Mayor o igual que</option> 
                        <option value="LessOrEqual">Menor o igual que</option>
                        <option value="IsAnyOf">Es cualquiera de</option>
                        <option value="IsNoneOf">Es ninguno de</option>
                        <option value="HasAnyOf">Tiene cualquiera de</option>
                        <option value="HasAllOf">Tiene todo de</option>
                        <option value="Empty">Vacio</option>
                        <option value="NotEmpty">No vacio</option>
                    </select>
                    <input type="text" id="filterValue" placeholder="Valor de filtro">
                    <div id="filtroContainer">

                    </div>
                </div>
                <div class="botones" >
                    <button class="agregarFiltro" type="button" onclick="agregarFiltro()">Agregar filtro</button>
                    <button type="button" id="botonAplicar" onclick="aplicarFiltros()" disabled>Aplicar filtro</button>
                    <button class="actualizar" type="button"onclick="recargarIframe()">Actualizar</button>
                    <button class="limpiarFiltro" type="button" onclick="limpiarFiltros()">Limpiar filtros</button>
                    <button id="botonMostrarFiltros" type="button" onclick="mostrarFiltros()">Filtros</button>
                </div>
                <!-- Pop-up -->
                <div class="popup" id="popup">
                    <button class="close-button" onclick="cerrarPopup()">&#10006;</button>
                </div>
            </nav>
            <!-- Aqui se define URL base -->
        </section>
        <div class="wrapper">
            <p id="bottomParagraph">© Copyrigth 2023 Todos los derechos reservados.  </p>
            <div class="hidelogo">
            </div>
            <iframe id="myIframe" allowfullscreen ></iframe>
        </div>

        <iframe id="myIframe2" src="" style="width: 100%; height: 900; display: none;" frameborder="0"></iframe>
    </main>
    <br>
    <!-- Contenedor para el contenido duplicado -->
    <div id="contenidoDuplicado">

    </div>

</body>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const select = document.getElementById('filterFieldName');
    const newBaseUrl = urlParams.get('baseUrl');

    if (newBaseUrl) {
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;
    }

    // Definir una funcion para agregar una opcion al select
    function agregarOpcion(valor) {
        const option = document.createElement('option');
        option.value = valor;
        option.textContent = valor;
        select.appendChild(option);
    }

    // Obtener y agregar opciones para los 30 parámetros (c1, c2, ..., c30)
    for (let i = 1; i <= 30; i++) {
        const paramName = 'c' + i;
        const paramValue = urlParams.get(paramName);
        if (paramValue) {
            agregarOpcion(paramValue);
        }
    }

    //Obtener los parametros por URL Logo, titulo del documento y pagina
    const logo = urlParams.get('logo');
    const logoImage = document.getElementById('logoImage');
    logoImage.src = logo;

    if (logo){
        logoImage.src = logo;
    }else{
        logoImage.src = '/img/Mesa de trabajo 2.png'
    }

    const titleD = urlParams.get('title');
    const titleDocument = document.getElementById('titleDocument');
    titleDocument.innerHTML = titleD;

    const favIcon = urlParams.get('favicon');
    const favicon = document.getElementById('favIcon');
    favicon.href = favIcon;

    // const favIcon = urlParams.get('favicon');
    // const favicon = document.getElementById('favIcon');
    // favicon.innerHTML = favIcon;

    const bottomParagraph = urlParams.get('parrafoB') ||'© Copyrigth 2023 Todos los derechos reservados.' ; 
    const bottomP = document.getElementById('bottomParagraph');
    bottomP.innerHTML = bottomParagraph;

    const paragraph = urlParams.get('parrafo');
    const title = document.getElementById('title');
    title.innerHTML = paragraph;

    //////////////////////////////////////////////

    const condiciones = [];

    function agregarFiltro() {
    const campo = document.getElementById("filterFieldName").value;
    const valor = document.getElementById("filterValue").value;
    const tipoDeFiltro = document.getElementById("filterType").value;

    if (campo && tipoDeFiltro && valor) {
        condiciones.push({ campo, tipoDeFiltro, valor });
        document.getElementById("filterFieldName").value = "";
        document.getElementById("filterValue").value = "";
        document.getElementById("filterType").value = "";

        // Habilita el botón "Aplicar filtro"
        document.getElementById("botonAplicar").disabled = false;
    } else {
        alert("Por favor, complete todos los campos para agregar un filtro.");
    }

    aplicarFiltros();

    // Actualiza el contador de filtros
    actualizarContadorFiltros();
}


    function eliminarFiltro(index) {
        condiciones.splice(index, 1);
        const filtroContainer = document.getElementById("filtroContainer");
        filtroContainer.innerHTML = "";
        aplicarFiltros();

        // Deshabilita el boton "Aplicar filtro" si no hay mas filtros
        if (condiciones.length === 0) {
            document.getElementById("botonAplicar").disabled = true;
            cerrarPopup();
        }
            


        // Actualiza el contador de filtros
        actualizarContadorFiltros();
        //Mostrar los filtros restantes
        mostrarFiltros();

    }

    function mostrarFiltros() {
    // Crea un objeto que mapee los valores de las opciones a sus textos
    const opciones = {
        "Contains": "Contiene",
        "Equals": "Es igual a",
        "Greater": "Mayor que",
        "Less": "Menor que",
        "NotContains": "No contiene",
        "NotEquals": "No es igual a",
        "GreaterOrEqual": "Mayor o igual que",
        "LessOrEqual": "Menor o igual que",
        "IsAnyOf": "Es cualquiera de",
        "IsNoneOf": "No es ninguno de",
        "HasAnyOf": "Tiene cualquiera de",
        "HasAllOf": "Tiene todos de",
        "Empty": "Vacio",   
        "NotEmpty": "No está vacio"
    };
    

    const popup = document.getElementById("popup");
    let contenido = "<h4>Filtros Agregados:</h4>";
    for (let i = 0; i < condiciones.length; i++) {
        const condicion = condiciones[i];
        // Obtiene el texto de la opción correspondiente al valor del filtro
        const textoOpcion = opciones[condicion.tipoDeFiltro];
        contenido += `<p>${condicion.campo} ${textoOpcion} ${condicion.valor} <button onclick="eliminarFiltro(${i})"><svg id="fi_10516181" enable-background="new 0 0 28 28" viewBox="0 0 0 auto" xmlns="http://www.w3.org/2000/svg"><switch><foreignObject height="1" requiredExtensions="http://ns.adobe.com/AdobeIllustrator/10.0/" width="1"></foreignObject><g><path d="m18 26h-8c-2.2 0-4-1.8-4-4v-13c0-.6.4-1 1-1h14c.6 0 1 .4 1 1v13c0 2.2-1.8 4-4 4zm-10-16v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-12zm8 12c-.6 0-1-.4-1-1v-8c0-.6.4-1 1-1s1 .4 1 1v8c0 .6-.4 1-1 1zm-4 0c-.6 0-1-.4-1-1v-8c0-.6.4-1 1-1s1 .4 1 1v8c0 .6-.4 1-1 1zm10-16h-16c-.6 0-1-.4-1-1s.4-1 1-1h4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2h4c.6 0 1 .4 1 1s-.4 1-1 1zm-10-2h4z"></path></g></switch></svg></button></p>`;
    }
    contenido += '<button class="close-button" onclick="cerrarPopup()">✖</button>';
    popup.innerHTML = contenido;

}


    function aplicarFiltros() {
        if (newBaseUrl) {
            let iframeUrl = newBaseUrl;
            condiciones.forEach((condicion, index) => {
                const { campo, tipoDeFiltro, valor } = condicion;
                const valorCodificado = encodeURIComponent(valor);
                iframeUrl += `&filter${tipoDeFiltro}_${campo}=${valorCodificado}`;
            });
            const iframe = document.getElementById("myIframe");
            iframe.src = iframeUrl;
        } else {
            alert("Agregue una URL base antes de aplicar filtros.");
        }
    }

    function actualizarContadorFiltros() {
        const botonMostrarFiltros = document.getElementById("botonMostrarFiltros");
        botonMostrarFiltros.textContent = `Filtros (${condiciones.length})`;
    }

    function limpiarFiltros() {
        const filtroContainer = document.getElementById("filtroContainer");
        filtroContainer.innerHTML = "";
        condiciones.length = 0;
        const iframe = document.getElementById("myIframe");
        iframe.src = newBaseUrl;
        document.getElementById("filterFieldName").value = "";
        document.getElementById("filterValue").value = "";
        document.getElementById("filterType").value = "";

        actualizarContadorFiltros();

    }

    // function recargarIframe() {
    //     const iframe = document.getElementById("myIframe");
    //     iframe.src = newBaseUrl;
    // }

    function recargarIframe() {
    const iframe = document.getElementById("myIframe");
    const iframeUrl = iframe.src; // Obtener la URL actual del iframe
    iframe.src = iframeUrl; // Establece la misma URL para recargar el iframe
}


    const filterButton = document.getElementById('botonMostrarFiltros');
    const popup = document.getElementById('popup');


    function togglePopup() {
        popup.classList.toggle('show-popup');
    }

    filterButton.addEventListener('click', () => {
        togglePopup();
    });

    function cerrarPopup() {
    togglePopup();
}

    // Obtener la imagen y la sección por su ID
    const logoFilter = document.getElementById("logoFilter");
    const miSeccion = document.getElementById("miSeccion");

    // Variable para llevar un registro de si la seccion está visible o no
    let seccionVisible = true;

    // Agregar un evento de click a la imagen
    logoFilter.addEventListener("click", function() {
        if (seccionVisible) {
        // Si la seccion esta <visible, ocultar
        miSeccion.style.display = "none";
        } else {
        // Si la sección esta oculta, mostrar
        miSeccion.style.display = "block";
        }

        // Cambia el valor de seccionVisible al valor opuesto
        seccionVisible = !seccionVisible;
    });

    const iframe = document.getElementById("myIframe2");
    const buttonMostrar = document.getElementById("mostrar");
    const buttonOcultar = document.getElementById("ocultar");

    iframe.style.display = "none";
    buttonOcultar.style.display = "none";

    buttonMostrar.title = "Mostrar tabla"
    buttonOcultar.title = "Ocultar tabla"

    buttonMostrar.addEventListener("click", function() {
        // Cuando se hace clic en el boton de mostrar, se muestra el iframe y el boton de ocultar
        iframe.style.display = "block";
        buttonOcultar.style.display = "block";
        
        // Ocultar boton mostrar
        buttonMostrar.style.display = "none";
    });

    buttonOcultar.addEventListener("click", function() {
        // Cuando se hace clic en el boton de ocultar, se oculta el iframe y el boton de ocultar
        iframe.style.display = "none";
        buttonOcultar.style.display = "none";
        
        // Mostrar el boton mostrar
        buttonMostrar.style.display = "block";
    });

    // Se carga url de la ubicacion actual
    window.onload = function() {
    const iframe = document.getElementById("myIframe2");
    iframe.src = window.location.href;
}


    iframe.addEventListener("load", function() {
        const botonDentroDelIframe = iframe.contentWindow.document.getElementById("mostrar");
        const parrafoDentroDelIframe = iframe.contentWindow.document.getElementById("bottomParagraph");

        if (botonDentroDelIframe) {
            botonDentroDelIframe.style.display = "none";
        }
        if(parrafoDentroDelIframe) {
            parrafoDentroDelIframe.style.display = "none";
        }

    });



</script>
</html>
